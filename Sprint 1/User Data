#!/bin/bash
#Atualizando pacotes
echo "Atualizando pacotes e instalando Nginx e Curl..."
apt-get update -y
apt-get install nginx curl -y

echo "Configurando o firewall UFW para Nginx..."
ufw enable
ufw allow 'Nginx HTTP'
ufw allow 'Nginx HTTPS'

#Baixando o index.html desse mesmo reposit칩rio
echo "Baixando o arquivo HTML do reposit칩rio GitHub..."
curl -o /var/www/html/index.html https://raw.githubusercontent.com/LuanLindolfo/PB-Compass/main/Sprint%201/index.html

echo "Reiniciando o Nginx..."
systemctl restart nginx

#Monitoramento e Webhook
echo "Criando o diret칩rio de logs de monitoramento..."
mkdir -p /var/log/monitoramento_web

echo "Criando o script de monitoramento..."
cat > /usr/local/bin/monitoramentobin.sh << EOF_SCRIPT
#!/bin/bash
SITE_URL="http://localhost"
WEBHOOK_URL="URL do seu WEBHOOK"
TIMESTAMP=\$(date +"%Y-%m-%d %H:%M:%S")

#Verifica se o Nginx est치 ativo. O comando retorna 0 se ativo.
systemctl is-active --quiet nginx

if [ \$? -ne 0 ]; then
    # Se o Nginx n칚o estiver ativo, ele envia uma notifica칞칚o de alerta
    # e tenta reiniciar o servi칞o.
    MESSAGE="**丘멆잺 ALERTA: O Nginx estava OFFLINE!** Tentando reinici치-lo... 游댃"
    COLOR=16766720 # Amarelo
    
    curl -H "Content-Type: application/json" -X POST -d '{
        "embeds": [
        {
            "title": "Status do Site",
            "description": "'"\$MESSAGE"'",
            "color": '"\$COLOR"',
            "footer": {
                "text": "칔ltima verifica칞칚o em '"\$TIMESTAMP"'"
            }
        }
        ]
    }' \$WEBHOOK_URL
    
    systemctl restart nginx
    sleep 5 # Espera um pouco para o Nginx reiniciar
    
fi

#Verifica o status HTTP do site para a notifica칞칚o final
STATUS_CODE=\$(curl -o /dev/null -s -w "%{http_code}\n" \$SITE_URL)

if [ "\$STATUS_CODE" -eq 200 ]; then
    MESSAGE="Site em produ칞칚o: \$SITE_URL est치 online! 游꿀"
    COLOR=3066993 # Verde
else
    MESSAGE="**丘멆잺 ALERTA: O site \$SITE_URL est치 OFFLINE!** 游뚿"
    COLOR=15158332 # Vermelho
fi

curl -H "Content-Type: application/json" -X POST -d '{
    "embeds": [
    {
        "title": "Status do Site",
        "description": "'"\$MESSAGE"'",
        "color": \$COLOR,
        "footer": {
            "text": "칔ltima verifica칞칚o em '"\$TIMESTAMP"'"
        }
    }
    ]
}' \$WEBHOOK_URL
EOF_SCRIPT

echo "Tornando o script execut치vel e configurando o crontab..."
chmod +x /usr/local/bin/monitoramentobin.sh
(crontab -l 2>/dev/null; echo "* * * * * /usr/local/bin/monitoramentobin.sh >> /var/log/monitoramento_web/cron_output.log 2>&1") | crontab -

echo "Configura칞칚o do ambiente conclu칤da com sucesso!"
